<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Estado da Autentica√ß√£o</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { 
            padding: 40px;
            background-color: #f8f9fa;
        }
        .debug-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .code { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">üîç Debug - Estado da Autentica√ß√£o</h1>
        
        <div class="debug-card">
            <h3>1. Status do LocalStorage</h3>
            <div id="localStorage-info"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="checkLocalStorage()">Verificar Novamente</button>
        </div>

        <div class="debug-card">
            <h3>2. Status do API Client</h3>
            <div id="api-client-info"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="checkAPIClient()">Verificar Novamente</button>
        </div>

        <div class="debug-card">
            <h3>3. Teste de Login</h3>
            <button class="btn btn-primary" onclick="testLogin()">Fazer Login de Teste</button>
            <button class="btn btn-warning ms-2" onclick="clearAuth()">Limpar Autentica√ß√£o</button>
            <div id="login-test-result" class="mt-3"></div>
        </div>

        <div class="debug-card">
            <h3>4. Navega√ß√£o de Teste</h3>
            <a href="index.php" class="btn btn-success">Ir para Dashboard</a>
            <a href="users-list.php" class="btn btn-info ms-2">Ir para Usu√°rios</a>
            <a href="auth-sign-in.php" class="btn btn-secondary ms-2">Ir para Login</a>
        </div>

        <div class="debug-card">
            <h3>5. Log de Console</h3>
            <div id="console-log" class="code" style="height: 200px; overflow-y: auto; background: #000; color: #0f0;"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="clearConsoleLog()">Limpar Log</button>
        </div>
    </div>

    <!-- API Client -->
    <script src="assets/js/api-client.js"></script>

    <script>
        // Capturar logs do console
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        let consoleLogDiv;

        function addToConsoleLog(type, message) {
            if (!consoleLogDiv) {
                consoleLogDiv = document.getElementById('console-log');
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            consoleLogDiv.textContent += logEntry;
            consoleLogDiv.scrollTop = consoleLogDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsoleLog('log', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsoleLog('warn', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsoleLog('error', args.join(' '));
        };

        function clearConsoleLog() {
            document.getElementById('console-log').textContent = '';
        }

        function checkLocalStorage() {
            const localStorageInfo = document.getElementById('localStorage-info');
            const storageData = {};
            
            // Verificar todas as chaves do localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                storageData[key] = value;
            }
            
            localStorageInfo.innerHTML = `
                <div class="code">${JSON.stringify(storageData, null, 2)}</div>
                <p><strong>Total de itens:</strong> ${localStorage.length}</p>
            `;
        }

        function checkAPIClient() {
            const apiClientInfo = document.getElementById('api-client-info');
            
            if (typeof window.eventosAPI !== 'undefined') {
                const isLoggedIn = window.eventosAPI.isLoggedIn();
                const token = window.eventosAPI.getToken();
                const currentUser = window.eventosAPI.getCurrentUser();
                
                apiClientInfo.innerHTML = `
                    <div class="status-ok">‚úÖ API Client carregado</div>
                    <div class="code">
Status de Login: ${isLoggedIn}
Token presente: ${token ? 'Sim' : 'N√£o'}
Token: ${token ? token.substring(0, 50) + '...' : 'Nenhum'}
Usu√°rio atual: ${JSON.stringify(currentUser, null, 2)}
                    </div>
                `;
            } else {
                apiClientInfo.innerHTML = `
                    <div class="status-error">‚ùå API Client n√£o carregado</div>
                `;
            }
        }

        async function testLogin() {
            const resultDiv = document.getElementById('login-test-result');
            resultDiv.innerHTML = '<div class="status-warning">üîÑ Fazendo login...</div>';
            
            try {
                const result = await window.eventosAPI.login('admin@mathetes.com', '123456');
                
                resultDiv.innerHTML = `
                    <div class="status-ok">‚úÖ Login realizado com sucesso</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                `;
                
                // Atualizar informa√ß√µes ap√≥s login
                setTimeout(() => {
                    checkLocalStorage();
                    checkAPIClient();
                }, 500);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status-error">‚ùå Erro no login</div>
                    <div class="code">${error.message}</div>
                `;
            }
        }

        function clearAuth() {
            if (window.eventosAPI) {
                window.eventosAPI.logout();
            }
            
            // Limpar manualmente tamb√©m
            localStorage.removeItem('eventos_token');
            localStorage.removeItem('eventos_refresh_token');
            localStorage.removeItem('eventos_user');
            
            document.getElementById('login-test-result').innerHTML = `
                <div class="status-warning">‚ö†Ô∏è Autentica√ß√£o limpa</div>
            `;
            
            setTimeout(() => {
                checkLocalStorage();
                checkAPIClient();
            }, 500);
        }

        // Verificar estado inicial
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkLocalStorage();
                checkAPIClient();
                addToConsoleLog('info', 'Debug page loaded');
            }, 100);
        });
    </script>
</body>
</html>